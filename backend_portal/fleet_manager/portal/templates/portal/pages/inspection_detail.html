{% extends 'portal/base.html' %}
{% load static %}
{% block title %}Inspection Detail · Fleet Manager{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Inspection Detail</h4>
  <div>
    <a href="{% url 'portal-inspections' %}" class="btn btn-outline-secondary">Back to Inspections</a>
    <a href="{% url 'inspection-report' inspection.id %}" class="btn btn-primary" target="_blank">View Report</a>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <!-- Inspection Overview Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Inspection Overview</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Reference:</strong> <code>{{ inspection.reference }}</code></p>
            <p><strong>Status:</strong> <span class="badge bg-light text-dark">{{ inspection.get_status_display }}</span></p>
            <p><strong>Created:</strong> {{ inspection.created_at|date:'Y-m-d H:i' }}</p>
            {% if inspection.started_at %}
            <p><strong>Started:</strong> {{ inspection.started_at|date:'Y-m-d H:i' }}</p>
            {% endif %}
            {% if inspection.completed_at %}
            <p><strong>Completed:</strong> {{ inspection.completed_at|date:'Y-m-d H:i' }}</p>
            {% endif %}
          </div>
          <div class="col-md-6">
            <p><strong>Vehicle:</strong> {{ inspection.vehicle.license_plate }} · {{ inspection.vehicle.make }} {{ inspection.vehicle.model }} ({{ inspection.vehicle.year }})</p>
            <p><strong>Customer:</strong> {{ inspection.customer.legal_name }}</p>
            <p><strong>Inspector:</strong> {{ inspection.inspector.profile.user.get_full_name|default:inspection.inspector.profile.user.username }}</p>
            <p><strong>Odometer:</strong> {{ inspection.odometer_reading }} miles</p>
          </div>
        </div>
        {% if inspection.general_notes %}
        <div class="mt-3">
          <h6>General Notes</h6>
          <p class="text-muted">{{ inspection.general_notes|linebreaks }}</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Findings by Category -->
    {% for category, responses in responses_by_category.items %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">{{ category.name }}</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Item</th>
                <th>Result</th>
                <th>Severity</th>
                <th>Notes</th>
                <th>Photos</th>
              </tr>
            </thead>
            <tbody>
              {% for response in responses %}
              <tr>
                <td>{{ response.checklist_item.title }}</td>
                <td>
                  {% if response.result == 'pass' %}
                  <span class="badge bg-success">Pass</span>
                  {% elif response.result == 'fail' %}
                  <span class="badge bg-danger">Fail</span>
                  {% else %}
                  <span class="badge bg-secondary">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if response.result != 'not_applicable' %}
                  <span class="badge bg-light text-dark">{{ response.severity }}/5</span>
                  {% endif %}
                </td>
                <td>{{ response.notes|default:'-'|linebreaksbr }}</td>
                <td>
                  {% if response.photos.all %}
                  <div class="d-flex flex-wrap gap-2">
                    {% for photo in response.photos.all %}
                    <a href="{{ photo.image.url }}" target="_blank">
                      <img src="{{ photo.image.url }}" alt="{{ photo.caption|default:'Inspection photo' }}" class="img-thumbnail" style="max-width: 100px; max-height: 100px;">
                    </a>
                    {% endfor %}
                  </div>
                  {% else %}
                  -
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="card mb-4">
      <div class="card-body text-center text-muted">
        No findings recorded for this inspection.
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="col-lg-4">
    <!-- Summary Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Summary</h5>
      </div>
      <div class="card-body">
        <p><strong>Total Items:</strong> {{ inspection.item_responses.count }}</p>
        <p><strong>Passed:</strong> {{ passed_count }}</p>
        <p><strong>Failed:</strong> {{ failed_count }}</p>
        <p><strong>Not Applicable:</strong> {{ na_count }}</p>
        
        {% if inspection.customer_report %}
        <hr>
        <h6>Report Summary</h6>
        <p>{{ inspection.customer_report.summary|linebreaks }}</p>
        {% if inspection.customer_report.recommended_actions %}
        <h6>Recommended Actions</h6>
        <p>{{ inspection.customer_report.recommended_actions|linebreaks }}</p>
        {% endif %}
        {% endif %}
      </div>
    </div>

    <!-- Assignment Info (if applicable) -->
    {% if inspection.assignment %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Assignment</h5>
      </div>
      <div class="card-body">
        <p><strong>Scheduled For:</strong> {{ inspection.assignment.scheduled_for|date:'Y-m-d' }}</p>
        <p><strong>Status:</strong> <span class="badge bg-light text-dark">{{ inspection.assignment.get_status_display }}</span></p>
        {% if inspection.assignment.remarks %}
        <p><strong>Remarks:</strong> {{ inspection.assignment.remarks|linebreaksbr }}</p>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}