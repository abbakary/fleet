{% extends "portal/base.html" %}
{% load static %}

{% block title %}Dashboard — Fleet Manager{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <section class="dashboard-hero">
    <div class="dashboard-hero-content">
      <div class="dashboard-hero-badge"><i class="fas fa-bolt"></i> Control Center</div>
      <h1>Welcome back{% if profile and profile.user.first_name %}, {% endif %}{% if profile %}{{ profile.user.get_full_name|default:profile.user.username }}{% else %}{{ request.user.get_full_name|default:request.user.username }}{% endif %}</h1>
      <p>Manage customers, vehicles, assignments and inspections from a unified dashboard. Quick actions and insights help you keep operations moving.</p>
      <div class="dashboard-hero-actions">
        <a class="hero-action primary" href="{% url 'portal-assignments-new' %}" hx-get="{% url 'portal-assignments-new' %}" hx-target="#portalDynamic" hx-swap="innerHTML" hx-push-url="true"><i class="fas fa-plus-circle"></i> New Assignment</a>
        <a class="hero-action ghost" href="{% url 'portal-inspections' %}"><i class="fas fa-clipboard-list"></i> All Inspections</a>
      </div>
    </div>
    <div class="dashboard-hero-metrics">
      <div class="hero-stat">
        <span class="hero-stat-label">Inspections</span>
        <span class="hero-stat-value">{{ kpi_inspections }}</span>
        <span class="hero-stat-caption">Total inspections</span>
      </div>
      <div class="hero-stat">
        <span class="hero-stat-label">Active Assignments</span>
        <span class="hero-stat-value">{{ kpi_pending_assignments }}</span>
        <span class="hero-stat-caption">Pending assignments</span>
      </div>
    </div>
  </section>

  <div class="dashboard-kpi-grid">
    <div class="kpi-card primary">
      <div class="kpi-content">
        <div class="kpi-text">
          <div class="kpi-label">Customers</div>
          <div class="kpi-value">{{ kpi_customers }}</div>
          <div class="kpi-chip neutral"><i class="fas fa-users"></i> Registered</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-users"></i></div>
      </div>
    </div>

    <div class="kpi-card secondary">
      <div class="kpi-content">
        <div class="kpi-text">
          <div class="kpi-label">Vehicles</div>
          <div class="kpi-value">{{ kpi_vehicles }}</div>
          <div class="kpi-chip neutral"><i class="fas fa-truck"></i> Fleet</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-truck"></i></div>
      </div>
    </div>

    <div class="kpi-card success">
      <div class="kpi-content">
        <div class="kpi-text">
          <div class="kpi-label">Inspectors</div>
          <div class="kpi-value">{{ kpi_inspectors }}</div>
          <div class="kpi-chip positive"><i class="fas fa-user-check"></i> Active</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-user-check"></i></div>
      </div>
    </div>

    <div class="kpi-card warning">
      <div class="kpi-content">
        <div class="kpi-text">
          <div class="kpi-label">Assignments</div>
          <div class="kpi-value">{{ kpi_assignments }}</div>
          <div class="kpi-chip attention"><i class="fas fa-tasks"></i> Scheduled</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-tasks"></i></div>
      </div>
    </div>
  </div>

  <div class="dashboard-panel-grid mt-3">
    <div class="dashboard-card">
      <div class="card-header">
        <h5>Inspection Overview</h5>
      </div>
      <div class="card-body">
        <canvas id="inspectionOverviewChart" height="180" aria-label="Inspection overview chart" role="img"></canvas>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5>Recent Inspections</h5>
        <input id="recentSearch" class="form-control form-control-sm" placeholder="Filter by license plate" hx-get="{% url 'portal-recent-inspections-partial' %}" hx-target="#recentTableBody" hx-trigger="keyup changed delay:500ms" name="q">
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table mb-0">
            <thead>
              <tr><th>Vehicle</th><th>Inspector</th><th>Status</th><th>Date</th></tr>
            </thead>
            <tbody id="recentTableBody">
              {% include 'portal/partials/recent_inspections_table.html' %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-header">
        <h5>Upcoming Assignments</h5>
      </div>
      <div class="card-body">
        <ul class="list-unstyled snapshot-list">
          {% for a in upcoming_assignments %}
          <li class="snapshot-item">
            <div class="snapshot-meta">
              <span class="snapshot-label">{{ a.vehicle.license_plate|default:a.vehicle.vin }}</span>
              <span class="snapshot-caption">{{ a.scheduled_for|date:"Y-m-d" }} — {{ a.inspector.profile.user.get_full_name|default:a.inspector.profile.user.username }}</span>
            </div>
            <div class="text-muted small">{{ a.get_status_display }}</div>
          </li>
          {% empty %}
          <li class="text-center text-muted">No upcoming assignments</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-header">
        <h5>Recent Customers</h5>
      </div>
      <div class="card-body">
        <ul class="list-unstyled snapshot-list">
          {% for c in recent_customers %}
          <li class="snapshot-item">
            <div class="snapshot-meta">
              <span class="snapshot-label">{{ c.profile.user.get_full_name|default:c.profile.user.username }}</span>
              <span class="snapshot-caption">{{ c.organization|default:'—' }}</span>
            </div>
            <div class="text-muted small">{{ c.created_at|date:"Y-m-d" }}</div>
          </li>
          {% empty %}
          <li class="text-center text-muted">No recent customers</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ inspection_status_cards|json_script:"inspection_status_data" }}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const statusData = JSON.parse(document.getElementById('inspection_status_data').textContent || '[]');
  const labels = statusData.map(s => s.label);
  const values = statusData.map(s => s.count);
  const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444'];

  const ctx = document.getElementById('inspectionOverviewChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: { labels: labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });

  // small animation for cards
  document.querySelectorAll('.dashboard-card, .kpi-card, .hero-stat').forEach((el, i)=>{
    el.style.transitionDelay = (i*40)+'ms';
    el.classList.add('animate__animated','animate__fadeInUp');
  });
});
</script>
{% endblock %}
