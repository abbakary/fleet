{% extends "portal/base.html" %}
{% load static %}
{% block title %}Fleet Manager Dashboard{% endblock %}

{% block extra_head %}
<style>
  /* Enhanced Dashboard Styles */
  .dashboard-kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .kpi-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
  }

  .kpi-card.primary::before { --gradient-start: #3b82f6; --gradient-end: #1d4ed8; }
  .kpi-card.secondary::before { --gradient-start: #8b5cf6; --gradient-end: #7c3aed; }
  .kpi-card.success::before { --gradient-start: #10b981; --gradient-end: #059669; }
  .kpi-card.warning::before { --gradient-start: #f59e0b; --gradient-end: #d97706; }
  .kpi-card.danger::before { --gradient-start: #ef4444; --gradient-end: #dc2626; }
  .kpi-card.info::before { --gradient-start: #06b6d4; --gradient-end: #0891b2; }

  .kpi-content {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
  }

  .kpi-text { flex: 1; }

  .kpi-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin-left: 15px;
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    color: white;
  }

  .kpi-value {
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
    margin: 8px 0 4px;
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .kpi-label {
    color: #64748b;
    font-size: 14px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .kpi-trend { display: flex; align-items: center; margin-top: 8px; font-size: 12px; font-weight: 600; }
  .kpi-trend.positive { color: #10b981; }
  .kpi-trend.negative { color: #ef4444; }

  /* Enhanced Cards */
  .dashboard-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: none; margin-bottom: 24px; transition: all 0.3s ease; }
  .dashboard-card:hover { box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); }
  .dashboard-card .card-header { background: white; border-bottom: 1px solid #e2e8f0; padding: 20px 24px 0; border-radius: 16px 16px 0 0 !important; }
  .dashboard-card .card-header h5 { font-weight: 600; color: #1e293b; margin: 0; }
  .dashboard-card .card-body { padding: 24px; }

  /* Progress Bars */
  .status-progress { height: 8px; border-radius: 10px; background-color: #f1f5f9; overflow: hidden; margin-top: 8px; }
  .status-progress .progress-bar { border-radius: 10px; transition: width 0.8s ease; }
  .status-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
  .status-item:last-child { border-bottom: none; margin-bottom: 0; }
  .status-info { display: flex; align-items: center; gap: 12px; }
  .status-badge { width: 8px; height: 8px; border-radius: 50%; }
  .status-badge.primary { background: #3b82f6; }
  .status-badge.success { background: #10b981; }
  .status-badge.warning { background: #f59e0b; }
  .status-badge.danger { background: #ef4444; }
  .status-badge.secondary { background: #8b5cf6; }

  /* Enhanced Tables */
  .dashboard-table { border: none; }
  .dashboard-table thead th { background: #f8fafc; border: none; padding: 16px 12px; font-weight: 600; color: #475569; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
  .dashboard-table tbody td { padding: 16px 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
  .dashboard-table tbody tr { transition: all 0.2s ease; }
  .dashboard-table tbody tr:hover { background: #f8fafc; }

  /* Quick Actions */
  .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 24px 0; }
  .action-btn { display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; text-decoration: none; color: #475569; transition: all 0.3s ease; font-weight: 500; }
  .action-btn:hover { border-color: #3b82f6; color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
  .action-btn i { font-size: 20px; width: 24px; }

  /* Charts Section */
  .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin: 30px 0; }
  .chart-container { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }

  /* Welcome Header */
  .welcome-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 30px; color: white; margin-bottom: 30px; position: relative; overflow: hidden; }
  .welcome-header::before { content: ''; position: absolute; top: 0; right: 0; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; transform: translate(40%, -40%); }
  .welcome-content h1 { font-weight: 700; margin-bottom: 8px; }
  .welcome-content p { opacity: 0.9; margin-bottom: 0; }

  /* Responsive */
  @media (max-width: 768px) {
    .dashboard-kpi-grid { grid-template-columns: 1fr; }
    .kpi-content { flex-direction: column; text-align: center; }
    .kpi-icon { margin: 15px auto 0; }
    .quick-actions { grid-template-columns: 1fr; }
  }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Header -->
<div class="welcome-header">
  <div class="row align-items-center">
    <div class="col-md-8">
      <div class="welcome-content">
        <h1>Operations Dashboard</h1>
        <p>Monitor your fleet operations, inspections, and assignments in real-time</p>
      </div>
    </div>
    <div class="col-md-4 text-md-end">
      <div class="d-inline-flex align-items-center bg-white bg-opacity-20 rounded-pill px-4 py-2">
        <i class="fas fa-sync-alt me-2"></i>
        <span>Updated just now</span>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
  <a href="{% url 'portal-assignments-new' %}" class="action-btn" data-portal-tab-target="assignments" hx-get="{% url 'portal-assignments-new' %}" hx-target="#portalContent" hx-swap="innerHTML">
    <i class="fas fa-plus-circle"></i>
    <span>Create Assignment</span>
  </a>
  <a href="{% url 'portal-customers' %}" class="action-btn" data-portal-tab-target="customers" hx-get="{% url 'portal-customers' %}" hx-target="#portalContent" hx-swap="innerHTML">
    <i class="fas fa-user-plus"></i>
    <span>Add Customer</span>
  </a>
  <a href="{% url 'portal-vehicles' %}" class="action-btn" data-portal-tab-target="vehicles" hx-get="{% url 'portal-vehicles' %}" hx-target="#portalContent" hx-swap="innerHTML">
    <i class="fas fa-truck-pickup"></i>
    <span>Register Vehicle</span>
  </a>
  <a href="{% url 'portal-inspections' %}" class="action-btn" data-portal-tab-target="inspections" hx-get="{% url 'portal-inspections' %}" hx-target="#portalContent" hx-swap="innerHTML">
    <i class="fas fa-clipboard-list"></i>
    <span>View Inspections</span>
  </a>
</div>

<!-- KPI Cards Grid -->
<div class="dashboard-kpi-grid">
  <div class="kpi-card primary">
    <div class="kpi-content">
      <div class="kpi-text">
        <div class="kpi-label">Total Customers</div>
        <div class="kpi-value">{{ kpi_customers }}</div>
        <div class="kpi-trend positive"><i class="fas fa-arrow-up me-1"></i><span>12% growth</span></div>
      </div>
      <div class="kpi-icon"><i class="fas fa-users"></i></div>
    </div>
  </div>

  <div class="kpi-card secondary">
    <div class="kpi-content">
      <div class="kpi-text">
        <div class="kpi-label">Active Vehicles</div>
        <div class="kpi-value">{{ kpi_vehicles }}</div>
        <div class="kpi-trend positive"><i class="fas fa-arrow-up me-1"></i><span>8% increase</span></div>
      </div>
      <div class="kpi-icon"><i class="fas fa-truck"></i></div>
    </div>
  </div>

  <div class="kpi-card warning">
    <div class="kpi-content">
      <div class="kpi-text">
        <div class="kpi-label">Total Inspections</div>
        <div class="kpi-value">{{ kpi_inspections }}</div>
        <div class="kpi-trend positive"><i class="fas fa-arrow-up me-1"></i><span>15% this month</span></div>
      </div>
      <div class="kpi-icon"><i class="fas fa-clipboard-check"></i></div>
    </div>
  </div>

  <div class="kpi-card success">
    <div class="kpi-content">
      <div class="kpi-text">
        <div class="kpi-label">Available Inspectors</div>
        <div class="kpi-value">{{ kpi_inspectors }}</div>
        <div class="kpi-trend positive"><i class="fas fa-arrow-up me-1"></i><span>2 new hires</span></div>
      </div>
      <div class="kpi-icon"><i class="fas fa-user-tie"></i></div>
    </div>
  </div>

  <div class="kpi-card danger">
    <div class="kpi-content">
      <div class="kpi-text">
        <div class="kpi-label">Pending Assignments</div>
        <div class="kpi-value">{{ kpi_pending_assignments }}</div>
        <div class="kpi-trend negative"><i class="fas fa-exclamation-circle me-1"></i><span>Requires attention</span></div>
      </div>
      <div class="kpi-icon"><i class="fas fa-tasks"></i></div>
    </div>
  </div>

  <div class="kpi-card info">
    <div class="kpi-content">
      <div class="kpi-text">
        <div class="kpi-label">Inspections In Progress</div>
        <div class="kpi-value">{{ kpi_in_progress_inspections }}</div>
        <div class="kpi-trend positive"><i class="fas fa-sync-alt me-1"></i><span>Active now</span></div>
      </div>
      <div class="kpi-icon"><i class="fas fa-hourglass-half"></i></div>
    </div>
  </div>
</div>

<!-- Status Overview Row -->
<div class="row">
  <div class="col-xl-6">
    <div class="dashboard-card">
      <div class="card-header">
        <div class="d-flex align-items-center justify-content-between">
          <h5>Inspection Status</h5>
          <a class="btn btn-sm btn-outline-primary" href="?tab=inspections" data-portal-tab="inspections" data-portal-url="{% url 'portal-inspections' %}">
            View Details <i class="fas fa-arrow-right ms-1"></i>
          </a>
        </div>
      </div>
      <div class="card-body">
        {% for status in inspection_status_cards %}
          <div class="status-item">
            <div class="status-info">
              <div class="status-badge {{ status.color|default:'primary' }}"></div>
              <div>
                <div class="fw-medium">{{ status.label }}</div>
                <small class="text-muted">{{ status.count }} inspections</small>
              </div>
            </div>
            <div class="text-end"><div class="fw-bold">{{ status.percent }}%</div></div>
          </div>
          <div class="status-progress">
            <div class="progress-bar bg-{{ status.color|default:'primary' }}" style="width: {{ status.percent }}%"></div>
          </div>
        {% empty %}
          <div class="text-center py-4 text-muted"><i class="fas fa-clipboard-list fa-2x mb-2"></i><p>No inspection data available</p></div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="col-xl-6">
    <div class="dashboard-card">
      <div class="card-header">
        <div class="d-flex align-items-center justify-content-between">
          <h5>Assignment Status</h5>
          <a class="btn btn-sm btn-outline-primary" href="?tab=assignments" data-portal-tab="assignments" data-portal-url="{% url 'portal-assignments' %}">
            View Details <i class="fas fa-arrow-right ms-1"></i>
          </a>
        </div>
      </div>
      <div class="card-body">
        {% for status in assignment_status_cards %}
          <div class="status-item">
            <div class="status-info">
              <div class="status-badge {{ status.color|default:'secondary' }}"></div>
              <div>
                <div class="fw-medium">{{ status.label }}</div>
                <small class="text-muted">{{ status.count }} assignments</small>
              </div>
            </div>
            <div class="text-end"><div class="fw-bold">{{ status.percent }}%</div></div>
          </div>
          <div class="status-progress">
            <div class="progress-bar bg-{{ status.color|default:'secondary' }}" style="width: {{ status.percent }}%"></div>
          </div>
        {% empty %}
          <div class="text-center py-4 text-muted"><i class="fas fa-tasks fa-2x mb-2"></i><p>No assignment data available</p></div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Recent Activity Row -->
<div class="row">
  <div class="col-xl-6">
    <div class="dashboard-card">
      <div class="card-header"><h5>Recent Inspections</h5></div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table dashboard-table">
            <thead><tr><th>Reference</th><th>Vehicle</th><th>Status</th><th>Updated</th></tr></thead>
            <tbody>
              {% for inspection in recent_inspections %}
                <tr>
                  <td class="fw-medium">{{ inspection.reference }}</td>
                  <td><div>{{ inspection.vehicle.license_plate }}</div><small class="text-muted">{{ inspection.vehicle.customer.legal_name }}</small></td>
                  <td><span class="badge bg-light-{{ inspection.status_color }} text-{{ inspection.status_color }} text-uppercase">{{ inspection.get_status_display }}</span></td>
                  <td class="text-nowrap"><small>{{ inspection.updated_at|timesince }} ago</small></td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center p-4 text-muted"><i class="fas fa-clipboard-list fa-2x mb-2"></i><p>No inspections recorded yet</p></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-6">
    <div class="dashboard-card">
      <div class="card-header"><h5>Upcoming Assignments</h5></div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table dashboard-table">
            <thead><tr><th>Vehicle</th><th>Inspector</th><th>Scheduled</th><th>Status</th></tr></thead>
            <tbody>
              {% for assignment in upcoming_assignments %}
                <tr>
                  <td><div>{{ assignment.vehicle.license_plate }}</div><small class="text-muted">{{ assignment.vehicle.customer.legal_name }}</small></td>
                  <td class="fw-medium">{{ assignment.inspector.profile.user.get_full_name|default:assignment.inspector.profile.user.username }}</td>
                  <td><div>{{ assignment.scheduled_for|date:"M d, Y" }}</div><small class="text-muted">{{ assignment.scheduled_for|time }}</small></td>
                  <td><span class="badge bg-light-info text-info text-uppercase">{{ assignment.get_status_display }}</span></td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center p-4 text-muted"><i class="fas fa-tasks fa-2x mb-2"></i><p>No scheduled assignments</p></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Customers -->
<div class="row">
  <div class="col-xl-6">
    <div class="dashboard-card">
      <div class="card-header"><h5>Recent Customers</h5></div>
      <div class="card-body">
        <div class="list-group list-group-flush">
          {% for customer in recent_customers %}
            <div class="list-group-item d-flex align-items-center justify-content-between px-0">
              <div class="d-flex align-items-center">
                <div class="avatar avatar-sm bg-light-primary rounded-circle me-3 d-flex align-items-center justify-content-center">
                  <i class="fas fa-building text-primary"></i>
                </div>
                <div>
                  <h6 class="mb-0">{{ customer.legal_name }}</h6>
                  <small class="text-muted">{{ customer.contact_email }}</small>
                </div>
              </div>
              <span class="badge bg-light-primary">Joined {{ customer.created_at|timesince }} ago</span>
            </div>
          {% empty %}
            <div class="text-center py-4 text-muted"><i class="fas fa-users fa-2x mb-2"></i><p>No customers yet</p></div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Empty State -->
<div id="portalContent" class="mt-4">
  <div class="dashboard-card">
    <div class="card-body text-center p-5">
      <div class="mb-4"><i class="fas fa-chart-line fa-4x text-primary mb-3"></i></div>
      <h3 class="mb-2">Welcome to Your Dashboard</h3>
      <p class="text-muted mb-4">Get started by exploring the navigation menu or create your first assignment</p>
      <a href="{% url 'portal-assignments-new' %}" class="btn btn-primary" data-portal-tab-target="assignments" hx-get="{% url 'portal-assignments-new' %}" hx-target="#portalContent" hx-swap="innerHTML">
        <i class="fas fa-plus me-2"></i>
        Create Your First Assignment
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add animation to KPI cards
    const kpiCards = document.querySelectorAll('.kpi-card');
    kpiCards.forEach((card, index) => {
      card.style.animationDelay = `${index * 0.1}s`;
      card.classList.add('animate__animated', 'animate__fadeInUp');
    });

    // Add loading animation to progress bars
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
      const width = bar.style.width;
      bar.style.width = '0';
      setTimeout(() => { bar.style.width = width; }, 500);
    });
  });
</script>
{% endblock %}
