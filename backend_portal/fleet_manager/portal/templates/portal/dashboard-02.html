{% extends "portal/base.html" %}
{% load static %}

{% block title %}Dashboard — Fleet Manager{% endblock %}

{% block extra_head %}
<style>
  .dashboard-shell { display:flex; flex-direction:column; gap:24px; }
  .dashboard-hero { display:flex; flex-wrap:wrap; gap:22px; align-items:stretch; background: linear-gradient(120deg,#1d4ed8 0%,#7c3aed 50%,#0ea5e9 100%); color:#fff; border-radius:22px; padding:26px; box-shadow:0 24px 48px rgba(2,6,23,.25); }
  .dashboard-hero-content { flex:1 1 440px; display:flex; flex-direction:column; gap:12px; }
  .dashboard-hero-badge { display:inline-flex; align-items:center; gap:8px; background: rgba(255,255,255,0.18); border:1px solid rgba(255,255,255,0.25); color:#fff; padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; letter-spacing:.08em; text-transform:uppercase; }
  .dashboard-hero h1 { margin:0; font-size:28px; font-weight:800; line-height:1.2; }
  .dashboard-hero p { margin:0; color: rgba(255,255,255,.9); }
  .dashboard-hero-actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:6px; }
  .hero-action { display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:14px; font-weight:700; }
  .hero-action.primary { background:#111827; color:#fff; box-shadow:0 14px 30px rgba(0,0,0,.25); }
  .hero-action.ghost { background: rgba(255,255,255,.16); color:#fff; border:1px solid rgba(255,255,255,.35); }
  .dashboard-hero-metrics { flex:1 1 320px; display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); }
  .hero-stat { background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.35); border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:4px; }
  .hero-stat-label { font-size:12px; opacity:.9; }
  .hero-stat-value { font-size:28px; font-weight:800; }
  .hero-stat-caption { font-size:12px; opacity:.9; }

  .dashboard-kpi-grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); }
  .kpi-card { border-radius:18px; background:#fff; box-shadow:0 18px 32px rgba(15,23,42,.12); padding:18px; transition:transform .2s ease, box-shadow .2s ease; }
  .kpi-card:hover { transform: translateY(-3px); box-shadow:0 24px 40px rgba(15,23,42,.16); }
  .kpi-content { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .kpi-text { display:flex; flex-direction:column; gap:6px; }
  .kpi-label { color:#475569; font-weight:600; font-size:13px; letter-spacing:.06em; text-transform:uppercase; }
  .kpi-value { font-size:30px; font-weight:800; color:#0f172a; }
  .kpi-chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600; }
  .kpi-chip.neutral { background:rgba(148,163,184,.18); color:#334155; }
  .kpi-chip.positive { background:rgba(16,185,129,.15); color:#065f46; }
  .kpi-chip.attention { background:rgba(245,158,11,.15); color:#92400e; }
  .kpi-icon { font-size:28px; color:#64748b; }
  .kpi-card.primary .kpi-icon { color:#1d4ed8; }
  .kpi-card.secondary .kpi-icon { color:#0ea5e9; }
  .kpi-card.success .kpi-icon { color:#10b981; }
  .kpi-card.warning .kpi-icon { color:#f59e0b; }

  .dashboard-panel-grid { display:grid; gap:18px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
  .snapshot-list { display:flex; flex-direction:column; gap:10px; margin:0; padding:0; }
  .snapshot-item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid rgba(148,163,184,.25); }
  .snapshot-item:last-child { border-bottom:none; }
  .snapshot-meta { display:flex; flex-direction:column; }
  .snapshot-label { font-weight:600; }
  .snapshot-caption { color:#64748b; font-size:13px; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <section class="dashboard-hero">
    <div class="dashboard-hero-content">
      <div class="dashboard-hero-badge"><i class="fas fa-bolt"></i> Control Center</div>
      <h1>Welcome back{% if profile and profile.user.first_name %}, {% endif %}{% if profile %}{{ profile.user.get_full_name|default:profile.user.username }}{% else %}{{ request.user.get_full_name|default:request.user.username }}{% endif %}</h1>
      <p>Manage customers, vehicles, assignments and inspections from a unified dashboard. Quick actions and insights help you keep operations moving.</p>
      <div class="dashboard-hero-actions">
        <a class="hero-action primary" href="{% url 'portal-assignments-new' %}" hx-get="{% url 'portal-assignments-new' %}" hx-target="#portalDynamic" hx-swap="innerHTML" hx-push-url="true"><i class="fas fa-plus-circle"></i> New Assignment</a>
        <a class="hero-action ghost" href="{% url 'portal-inspections' %}"><i class="fas fa-clipboard-list"></i> All Inspections</a>
      </div>
    </div>
    <div class="dashboard-hero-metrics">
      <div class="hero-stat">
        <span class="hero-stat-label">Inspections</span>
        <span class="hero-stat-value">{{ kpi_inspections }}</span>
        <span class="hero-stat-caption">Total inspections</span>
      </div>
      <div class="hero-stat">
        <span class="hero-stat-label">Active Assignments</span>
        <span class="hero-stat-value">{{ kpi_pending_assignments }}</span>
        <span class="hero-stat-caption">Pending assignments</span>
      </div>
    </div>
  </section>

  <div class="dashboard-kpi-grid">
    <div class="kpi-card primary">
      <div class="kpi-content">
        <div class="kpi-text">
          <div class="kpi-label">Customers</div>
          <div class="kpi-value">{{ kpi_customers }}</div>
          <div class="kpi-chip neutral"><i class="fas fa-users"></i> Registered</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-users"></i></div>
      </div>
    </div>

    <div class="kpi-card secondary">
      <div class="kpi-content">
        <div class="kpi-text">
          <div class="kpi-label">Vehicles</div>
          <div class="kpi-value">{{ kpi_vehicles }}</div>
          <div class="kpi-chip neutral"><i class="fas fa-truck"></i> Fleet</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-truck"></i></div>
      </div>
    </div>

    <div class="kpi-card success">
      <div class="kpi-content">
        <div class="kpi-text">
          <div class="kpi-label">Inspectors</div>
          <div class="kpi-value">{{ kpi_inspectors }}</div>
          <div class="kpi-chip positive"><i class="fas fa-user-check"></i> Active</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-user-check"></i></div>
      </div>
    </div>

    <div class="kpi-card warning">
      <div class="kpi-content">
        <div class="kpi-text">
          <div class="kpi-label">Assignments</div>
          <div class="kpi-value">{{ kpi_assignments }}</div>
          <div class="kpi-chip attention"><i class="fas fa-tasks"></i> Scheduled</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-tasks"></i></div>
      </div>
    </div>
  </div>

  <div class="dashboard-panel-grid mt-3">
    <div class="dashboard-card">
      <div class="card-header">
        <h5>Inspection Overview</h5>
      </div>
      <div class="card-body" style="height:240px">
        <canvas id="inspectionOverviewChart" aria-label="Inspection overview chart" role="img" style="width:100%;height:100%"></canvas>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5>Recent Inspections</h5>
        <input id="recentSearch" class="form-control form-control-sm" placeholder="Filter by license plate" hx-get="{% url 'portal-recent-inspections-partial' %}" hx-target="#recentTableBody" hx-trigger="keyup changed delay:500ms" name="q">
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table mb-0">
            <thead>
              <tr><th>Vehicle</th><th>Inspector</th><th>Status</th><th>Date</th></tr>
            </thead>
            <tbody id="recentTableBody">
              {% include 'portal/partials/recent_inspections_table.html' %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-header">
        <h5>Upcoming Assignments</h5>
      </div>
      <div class="card-body">
        <ul class="list-unstyled snapshot-list">
          {% for a in upcoming_assignments %}
          <li class="snapshot-item">
            <div class="snapshot-meta">
              <span class="snapshot-label">{{ a.vehicle.license_plate|default:a.vehicle.vin }}</span>
              <span class="snapshot-caption">{{ a.scheduled_for|date:"Y-m-d" }} — {{ a.inspector.profile.user.get_full_name|default:a.inspector.profile.user.username }}</span>
            </div>
            <div class="text-muted small">{{ a.get_status_display }}</div>
          </li>
          {% empty %}
          <li class="text-center text-muted">No upcoming assignments</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-header">
        <h5>Recent Customers</h5>
      </div>
      <div class="card-body">
        <ul class="list-unstyled snapshot-list">
          {% for c in recent_customers %}
          <li class="snapshot-item">
            <div class="snapshot-meta">
              <span class="snapshot-label">{{ c.profile.user.get_full_name|default:c.profile.user.username }}</span>
              <span class="snapshot-caption">{{ c.organization|default:'—' }}</span>
            </div>
            <div class="text-muted small">{{ c.created_at|date:"Y-m-d" }}</div>
          </li>
          {% empty %}
          <li class="text-center text-muted">No recent customers</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ inspection_status_cards|json_script:"inspection_status_data" }}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const statusData = JSON.parse(document.getElementById('inspection_status_data').textContent || '[]');
  const labels = statusData.map(s => s.label);
  const values = statusData.map(s => s.count);
  const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444'];

  const ctx = document.getElementById('inspectionOverviewChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: { labels: labels, datasets: [{ data: values, backgroundColor: colors.slice(0, values.length) }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });

  // small animation for cards
  document.querySelectorAll('.dashboard-card, .kpi-card, .hero-stat').forEach((el, i)=>{
    el.style.transitionDelay = (i*40)+'ms';
    el.classList.add('animate__animated','animate__fadeInUp');
  });
});
</script>
{% endblock %}
